<!DOCTYPE html>
<html>
<head>
    <title>IMU Raw Data - 10s Window</title>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        body { background: #111; color: #eee; font-family: sans-serif; margin: 0; }
        .chart-container { height: 30vh; width: 100%; margin-bottom: 5px; }
        h2 { font-size: 14px; margin: 5px; color: #4ade80; text-transform: uppercase; }
    </style>
</head>
<body>
    <h2>Accéléromètre (m/s²)</h2>
    <div id="accel-chart" class="chart-container"></div>
    
    <h2>Gyroscope (rad/s)</h2>
    <div id="gyro-chart" class="chart-container"></div>
    
    <h2>Magnétomètre (µT)</h2>
    <div id="mag-chart" class="chart-container"></div>

    <script>
        const socket = io();
        const windowSizeSeconds = 10;

        // Configuration initiale des graphiques
        function createPlot(elementId, labels) {
            const traces = labels.map(l => ({
                x: [], y: [], name: l, type: 'scatter', mode: 'lines',
                line: { width: 1.5 }
            }));
            const layout = {
                paper_bgcolor: '#111', plot_bgcolor: '#111',
                margin: { t: 10, b: 20, l: 40, r: 10 },
                xaxis: { color: '#666', gridcolor: '#222', title: 'Temps (s)' },
                yaxis: { color: '#666', gridcolor: '#222' },
                legend: { font: { color: '#eee' }, orientation: 'h', x: 0, y: 1.2 },
                showlegend: true
            };
            Plotly.newPlot(elementId, traces, layout, { responsive: true });
        }

        createPlot('accel-chart', ['AX', 'AY', 'AZ']);
        createPlot('gyro-chart', ['GX', 'GY', 'GZ']);
        createPlot('mag-chart', ['MX', 'MY', 'MZ']);

        socket.on('orientation_update', (data) => {
            const ts = new Date(); // Utilise l'heure de réception pour le graph glissant
            const olderTime = new Date(ts.getTime() - windowSizeSeconds * 1000);

            // Update Accel
            Plotly.extendTraces('accel-chart', {
                x: [[ts], [ts], [ts]],
                y: [[data.ax], [data.ay], [data.az]]
            }, [0, 1, 2]);

            // Update Gyro
            Plotly.extendTraces('gyro-chart', {
                x: [[ts], [ts], [ts]],
                y: [[data.gx], [data.gy], [data.gz]]
            }, [0, 1, 2]);

            // Update Mag
            Plotly.extendTraces('mag-chart', {
                x: [[ts], [ts], [ts]],
                y: [[data.mx], [data.my], [data.mz]]
            }, [0, 1, 2]);

            // Gestion de la fenêtre glissante (Axis Update)
            const update = {
                xaxis: { range: [olderTime, ts], color: '#666', gridcolor: '#222' }
            };
            Plotly.relayout('accel-chart', update);
            Plotly.relayout('gyro-chart', update);
            Plotly.relayout('mag-chart', update);
        });
    </script>
</body>
</html>